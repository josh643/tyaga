version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../apps/desktop/dist-renderer:/usr/share/nginx/html:ro
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
    depends_on:
      - api-gateway
      - n8n

  n8n:
    image: n8nio/n8n
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=user
      - DB_POSTGRESDB_PASSWORD=password
      - N8N_HOST=76.13.113.206
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://76.13.113.206/n8n/
      - N8N_EDITOR_BASE_URL=http://76.13.113.206/n8n/
      - N8N_PATH=/n8n/
      - N8N_SECURE_COOKIE=false
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
    depends_on:
      - postgres

  api-gateway:
    build:
      context: ../services/api-gateway
      dockerfile: Dockerfile
    environment:
      - PORT=3000
      - AUTH_SERVICE_URL=http://auth-service:3001
      - BRAND_SERVICE_URL=http://brand-management:3002
      - RIGHTS_SERVICE_URL=http://rights-tracking:3003
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 300M
    depends_on:
      - auth-service
      - brand-management

  auth-service:
    build:
      context: ../services/auth
      dockerfile: Dockerfile
    environment:
      - PORT=3001
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 300M
    depends_on:
      - postgres

  brand-management:
    build:
      context: ../services/brand-management
      dockerfile: Dockerfile
    environment:
      - PORT=3002
      - DB_HOST=postgres
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 300M
    depends_on:
      - postgres

  rights-tracking:
    build:
      context: ../services/rights-tracking
      dockerfile: Dockerfile
    environment:
      - PORT=3003
      - DB_HOST=postgres
      - MINIO_ENDPOINT=christopher-vault
      - MINIO_PORT=9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 300M
    depends_on:
      - postgres

  postgres:
    image: postgres:15-alpine
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: tyaga
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d

  christopher-vault:
    image: quay.io/minio/minio
    container_name: christopher-vault
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - /home/christopher/vault_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M

  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_CLEANUP=true
    deploy:
      resources:
        limits:
          cpus: '0.10'
          memory: 64M
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
